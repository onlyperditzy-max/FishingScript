-- FishingClient v3 (fixed & hardened)
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")
local StarterPack = game:GetService("StarterPack")
local player = Players.LocalPlayer

-- Remotes (gunakan WaitForChild untuk keamanan)
local StartRemote = ReplicatedStorage:WaitForChild("FishingStart")
local ReelRemote = ReplicatedStorage:WaitForChild("FishingReel")
local NotifyRemote = ReplicatedStorage:WaitForChild("FishingNotify")

-- DEV config (bisa diubah runtime via UI)
local DEV = {
    autoFish = true,
    autoPerfection = true,
    speedMultiplier = 1.0,
    instantCatch = true,
    superFast = 0,
    delayMode = 1.0,
    autoEquipRadar = true,
    animationEnabled = false,
}

-- Hapus GUI lama kalau ada (mencegah duplikasi saat hot-reload)
local existing = player:FindFirstChild("PlayerGui") and player.PlayerGui:FindFirstChild("FishingUI_v3")
if existing then
    existing:Destroy()
end

-- Build UI
local screen = Instance.new("ScreenGui")
screen.Name = "FishingUI_v3"
screen.ResetOnSpawn = false
screen.Parent = player:WaitForChild("PlayerGui")

local main = Instance.new("Frame")
main.Name = "Main"
main.Size = UDim2.new(0, 380, 0, 220)
main.Position = UDim2.new(0, 12, 0, 12)
main.BackgroundColor3 = Color3.fromRGB(12,12,12)
main.BorderSizePixel = 0
main.AnchorPoint = Vector2.new(0,0)
main.Parent = screen

local border = Instance.new("UIStroke")
border.Parent = main
border.Color = Color3.fromRGB(190,30,30)
border.Thickness = 2

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -24, 0, 30)
title.Position = UDim2.new(0,12,0,8)
title.BackgroundTransparency = 1
title.Font = Enum.Font.GothamBold
title.Text = "Fishing System v3"
title.TextColor3 = Color3.fromRGB(230,80,80)
title.TextSize = 20
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = main

local subtitle = Instance.new("TextLabel")
subtitle.Size = UDim2.new(1, -24, 0, 18)
subtitle.Position = UDim2.new(0,12,0,34)
subtitle.BackgroundTransparency = 1
subtitle.Font = Enum.Font.Gotham
subtitle.Text = "Debug â€¢ For your own game"
subtitle.TextColor3 = Color3.fromRGB(160,160,160)
subtitle.TextSize = 12
subtitle.TextXAlignment = Enum.TextXAlignment.Left
subtitle.Parent = main

local status = Instance.new("TextLabel")
status.Name = "Status"
status.Size = UDim2.new(1, -24, 0, 22)
status.Position = UDim2.new(0,12,0,54)
status.BackgroundTransparency = 1
status.Font = Enum.Font.Gotham
status.Text = "Ready"
status.TextColor3 = Color3.fromRGB(220,220,220)
status.TextSize = 14
status.TextXAlignment = Enum.TextXAlignment.Left
status.Parent = main

local progressHolder = Instance.new("Frame")
progressHolder.Size = UDim2.new(1, -24, 0, 14)
progressHolder.Position = UDim2.new(0,12,0,82)
progressHolder.BackgroundColor3 = Color3.fromRGB(30,30,30)
progressHolder.Parent = main

local progressBar = Instance.new("Frame")
progressBar.Size = UDim2.new(0, 0, 1, 0)
progressBar.Position = UDim2.new(0,0,0,0)
progressBar.BackgroundColor3 = Color3.fromRGB(200,60,60)
progressBar.Parent = progressHolder

local function btnStyle(btn)
    btn.BackgroundColor3 = Color3.fromRGB(22,22,22)
    btn.BorderSizePixel = 0
    local stroke = Instance.new("UIStroke")
    stroke.Parent = btn
    stroke.Color = Color3.fromRGB(140,20,20)
    stroke.Thickness = 1
    btn.Font = Enum.Font.Gotham
    btn.TextColor3 = Color3.fromRGB(240,240,240)
    btn.TextSize = 14
end

local startBtn = Instance.new("TextButton")
startBtn.Size = UDim2.new(0, 150, 0, 36)
startBtn.Position = UDim2.new(0,12,0,110)
startBtn.Text = "Start Fishing"
startBtn.Parent = main
btnStyle(startBtn)

local autoBtn = Instance.new("TextButton")
autoBtn.Size = UDim2.new(0, 90, 0, 28)
autoBtn.Position = UDim2.new(0,174,0,114)
autoBtn.Text = "Auto: Off"
autoBtn.Parent = main
btnStyle(autoBtn)

local perfBtn = Instance.new("TextButton")
perfBtn.Size = UDim2.new(0, 90, 0, 28)
perfBtn.Position = UDim2.new(0,174,0,148)
perfBtn.Text = "Perfect: Off"
perfBtn.Parent = main
btnStyle(perfBtn)

local superBtn = Instance.new("TextButton")
superBtn.Size = UDim2.new(0, 90, 0, 28)
superBtn.Position = UDim2.new(0,286,0,114)
superBtn.Text = "Super: Off"
superBtn.Parent = main
btnStyle(superBtn)

local delayBtn = Instance.new("TextButton")
delayBtn.Size = UDim2.new(0, 90, 0, 28)
delayBtn.Position = UDim2.new(0,286,0,148)
delayBtn.Text = "Delay: Off"
delayBtn.Parent = main
btnStyle(delayBtn)

local equipBtn = Instance.new("TextButton")
equipBtn.Size = UDim2.new(0, 180, 0, 28)
equipBtn.Position = UDim2.new(0,12,0,156)
equipBtn.Text = "Auto-Equip Radar: Off"
equipBtn.Parent = main
btnStyle(equipBtn)

local animBtn = Instance.new("TextButton")
animBtn.Size = UDim2.new(0, 120, 0, 28)
animBtn.Position = UDim2.new(0,200,0,182)
animBtn.Text = "Animation: On"
animBtn.Parent = main
btnStyle(animBtn)

local speedLabel = Instance.new("TextLabel")
speedLabel.Size = UDim2.new(0, 80, 0, 18)
speedLabel.Position = UDim2.new(0,200,0,156)
speedLabel.Text = "Speed: 1.0x"
speedLabel.BackgroundTransparency = 1
speedLabel.TextColor3 = Color3.fromRGB(220,220,220)
speedLabel.Font = Enum.Font.Gotham
speedLabel.TextSize = 12
speedLabel.Parent = main

local speedInc = Instance.new("TextButton")
speedInc.Size = UDim2.new(0, 40, 0, 18)
speedInc.Position = UDim2.new(0,286,0,156)
speedInc.Text = "+0.5"
speedInc.Parent = main
btnStyle(speedInc)

local speedDec = Instance.new("TextButton")
speedDec.Size = UDim2.new(0, 40, 0, 18)
speedDec.Position = UDim2.new(0,330,0,156)
speedDec.Text = "-0.5"
speedDec.Parent = main
btnStyle(speedDec)

-- State
local isFishing = false
local startTick = 0
local biteTick = nil

-- Helper UI funcs
local function setStatus(text)
    status.Text = text or ""
end

local function setProgress(p)
    p = math.clamp(p, 0, 1)
    progressBar.Size = UDim2.new(p, 0, 1, 0)
end

-- tryAutoEquipRadar (lebih aman)
local function tryAutoEquipRadar()
    if not DEV.autoEquipRadar then return end
    local backpack = player:WaitForChild("Backpack") -- Wait untuk kestabilan
    if backpack then
        local tool = backpack:FindFirstChild("FishingRadar")
        if tool and tool:IsA("Tool") then
            -- tunggu character dan humanoid
            if not player.Character then
                player.CharacterAdded:Wait()
            end
            local humanoid = player.Character and player.Character:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid:EquipTool(tool)
                setStatus("Radar auto-equipped.")
            end
            return
        end
    end
    -- fallback: clone dari StarterPack kalau ada
    local sp = StarterPack:FindFirstChild("FishingRadar")
    if sp and sp:IsA("Tool") then
        local bp = player:FindFirstChild("Backpack") or player:WaitForChild("Backpack")
        local clone = sp:Clone()
        clone.Parent = bp
        setStatus("Radar added to Backpack and equipped.")
        local humanoid = player.Character and player.Character:FindFirstChildOfClass("Humanoid")
        if humanoid then
            humanoid:EquipTool(clone)
        end
    end
end

-- Start fishing button
startBtn.MouseButton1Click:Connect(function()
    if isFishing then
        setStatus("Already fishing...")
        return
    end
    isFishing = true
    startTick = tick()
    setStatus("Casting...")
    setProgress(0)
    local req = { speed = DEV.speedMultiplier * (DEV.superFast > 0 and DEV.superFast or 1), delay = DEV.delayMode }
    -- FireServer aman
    local ok, err = pcall(function()
        StartRemote:FireServer(startTick, req)
    end)
    if not ok then
        warn("StartRemote FireServer failed: ", err)
        setStatus("Failed to start (server error).")
        isFishing = false
        return
    end
    task.spawn(tryAutoEquipRadar)
end)

-- Toggle UI buttons
autoBtn.MouseButton1Click:Connect(function()
    DEV.autoFish = not DEV.autoFish
    autoBtn.Text = "Auto: " .. (DEV.autoFish and "On" or "Off")
end)

perfBtn.MouseButton1Click:Connect(function()
    DEV.autoPerfection = not DEV.autoPerfection
    perfBtn.Text = "Perfect: " .. (DEV.autoPerfection and "On" or "Off")
end)

superBtn.MouseButton1Click:Connect(function()
    if DEV.superFast == 0 then
        DEV.superFast = 8
    elseif DEV.superFast == 8 then
        DEV.superFast = 10
    else
        DEV.superFast = 0
    end
    superBtn.Text = (DEV.superFast == 0) and "Super: Off" or ("Super: " .. tostring(DEV.superFast) .. "x")
    speedLabel.Text = "Speed: " .. tostring(DEV.speedMultiplier * (DEV.superFast > 0 and DEV.superFast or 1)) .. "x"
end)

delayBtn.MouseButton1Click:Connect(function()
    if DEV.delayMode == 1.0 then
        DEV.delayMode = 2.0
        delayBtn.Text = "Delay: 2x"
    else
        DEV.delayMode = 1.0
        delayBtn.Text = "Delay: Off"
    end
end)

equipBtn.MouseButton1Click:Connect(function()
    DEV.autoEquipRadar = not DEV.autoEquipRadar
    equipBtn.Text = "Auto-Equip Radar: " .. (DEV.autoEquipRadar and "On" or "Off")
    if DEV.autoEquipRadar then
        task.spawn(tryAutoEquipRadar)
    end
end)

animBtn.MouseButton1Click:Connect(function()
    DEV.animationEnabled = not DEV.animationEnabled
    animBtn.Text = "Animation: " .. (DEV.animationEnabled and "On" or "Off")
end)

speedInc.MouseButton1Click:Connect(function()
    DEV.speedMultiplier = math.floor((DEV.speedMultiplier + 0.5) * 10) / 10
    speedLabel.Text = "Speed: " .. tostring(DEV.speedMultiplier * (DEV.superFast > 0 and DEV.superFast or 1)) .. "x"
end)

speedDec.MouseButton1Click:Connect(function()
    DEV.speedMultiplier = math.max(0.1, math.floor((DEV.speedMultiplier - 0.5) * 10) / 10)
    speedLabel.Text = "Speed: " .. tostring(DEV.speedMultiplier * (DEV.superFast > 0 and DEV.superFast or 1)) .. "x"
end)

-- Handle notifications from server (robust checks)
NotifyRemote.OnClientEvent:Connect(function(payload)
    if type(payload) ~= "table" or not payload.event then return end

    local ev = payload.event

    if ev == "Started" then
        setStatus("Waiting for bite...")
        local target = payload.when or (tick() + 3) -- fallback: 3s if server didn't send time
        local start = startTick or tick()
        -- compute duration safely
        local total = math.max(0.01, (target - start))
        task.spawn(function()
            while isFishing and task.wait(0.03) and tick() < target do
                local elapsed = tick() - start
                -- prevent NaN / negative
                setProgress(math.clamp(elapsed / total, 0, 1))
            end
        end)

    elseif ev == "Bite" then
        biteTick = payload.serverTime or tick()
        if DEV.animationEnabled then
            setStatus("Fish is biting! Press E or 'Start Fishing' to reel.")
        else
            setStatus("Fish is biting! (animation off)")
        end
        setProgress(1)
        -- Reel logic with safer calculations
        if DEV.instantCatch then
            pcall(function() ReelRemote:FireServer(0) end)
        elseif DEV.autoPerfection then
            local denom = math.max(DEV.speedMultiplier * (DEV.superFast > 0 and DEV.superFast or 1), 0.01)
            local perfect = 3.0 / denom
            task.delay(perfect, function()
                if isFishing then
                    local elapsed = tick() - startTick
                    pcall(function() ReelRemote:FireServer(elapsed) end)
                end
            end)
        elseif DEV.autoFish then
            local denom = math.max(DEV.speedMultiplier * (DEV.superFast > 0 and DEV.superFast or 1), 0.01)
            local elapsed = 3.0 / denom
            pcall(function() ReelRemote:FireServer(elapsed) end)
        end

    elseif ev == "Result" then
        local res = payload.result or {}
        local quality = tostring(res.quality or "Unknown")
        local reward = tostring(res.reward or 0)
        setStatus("Result: " .. quality .. " +" .. reward)
        isFishing = false
        biteTick = nil
        task.delay(2, function()
            setStatus("Ready")
            setProgress(0)
        end)
    else
        -- unknown event - ignore gracefully
        -- optionally debug:
        -- warn("Received unknown fishing event: ", ev)
    end
end)

-- Input (reel manual)
UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Enum.KeyCode.E and isFishing then
        local elapsed = tick() - startTick
        pcall(function() ReelRemote:FireServer(elapsed) end)
    end
end)

-- Auto start loop (use task.wait)
task.spawn(function()
    while true do
        if DEV.autoFish and not isFishing then
            -- Activate button safely
            if startBtn and startBtn:IsA("GuiButton") then
                pcall(function() startBtn:Activate() end)
            end
        end
        task.wait(0.6)
    end
end)

print("FishingClient v3 loaded (Elegant UI) - patched.")
